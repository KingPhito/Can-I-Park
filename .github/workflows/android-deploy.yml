name: AndroidDeploy
run-name: Deploy AAB to Play Store

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout
          uses: actions/checkout@v4.1.0

        - name: Set up JDK 17
          uses: actions/setup-java@v4.1.0
          with:
            java-version: '17'
            distribution: 'adopt'

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Build output directory
          run: mkdir -p composeApp/build/outputs/bundle/release

        - name: Sign AAB
          uses: r0adkll/sign-android-release@v1
          with:
              releaseDirectory: composeApp/build/outputs/bundle/release
              signingKeyBase64: ${{ secrets.SIGNING_KEY_BASE64 }}
              alias: ${{ secrets.KEY_ALIAS }}
              keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
              keyPassword: ${{ secrets.KEY_PASSWORD }}

        - name: Deploy to Play Console
          uses: r0adkll/upload-google-play@v1.1.3
          with:
              serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
              packageName: com.rdugue.canipark
              releaseFile: ${{steps.sign_app.outputs.signedReleaseFile}}
              track: internal
              releaseName: ${{ github.run_number }}
              whatsNew: "Automated deployment of build ${{ github.run_number }}"

        - name: Delete build directory
          run: rm -rf composeApp/build

env:
  API_KEY: ${{ secrets.API_KEY }}